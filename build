#!/bin/bash

################################################################################
#                                    Config                                    #
################################################################################

# Whether to produce optimized, name-mangled, debugging-unfriendly JS.
OPTIMIZED=1

# Commands to use for various compilation steps.
LLVM=/home/max/emscripten-workspace/llvm-build/Release/bin/
CLOSURE_JAR=/home/max/emscripten-workspace/closure/build/compiler.jar
PYTHON=python2

# Which modules to build dynamically.
# Maps each module name to the C files implementing it.
declare -A MODULES
MODULES[array]="arraymodule.c"
MODULES[cmath]="cmathmodule.c _math.c"
MODULES[math]="mathmodule.c _math.c"
MODULES[strop]="stropmodule.c"
MODULES[time]="timemodule.c"
MODULES[datetime]="datetimemodule.c timemodule.c"
MODULES[itertools]="itertoolsmodule.c"
MODULES[future_builtins]="future_builtins.c"
MODULES[_random]="_randommodule.c"
MODULES[_collections]="_collectionsmodule.c"
MODULES[_bisect]="_bisectmodule.c"
MODULES[_heapq]="_heapqmodule.c"
MODULES[operator]="operator.c"
MODULES[_functools]="_functoolsmodule.c"
MODULES[_io]="_io/bufferedio.c _io/bytesio.c _io/fileio.c _io/iobase.c _io/_iomodule.c _io/stringio.c _io/textio.c"
MODULES[_json]="_json.c"
MODULES[_testcapi]="_testcapimodule.c"
MODULES[_hotshot]="_hotshot.c"
MODULES[_lsprof]="_lsprof.c rotatingtree.c"
MODULES[unicodedata]="unicodedata.c"
MODULES[_locale]="_localemodule.c"
MODULES[fcntl]="fcntlmodule.c"
MODULES[grp]="grpmodule.c"
MODULES[spwd]="spwdmodule.c"
MODULES[cStringIO]="cStringIO.c"
MODULES[cPickle]="cPickle.c"
MODULES[mmap]="mmapmodule.c"
MODULES[syslog]="syslogmodule.c"
MODULES[audioop]="audioop.c"
MODULES[imageop]="imageop.c"
MODULES[crypt]="cryptmodule.c"
MODULES[_csv]="_csv.c"
MODULES[_socket]="socketmodule.c"
MODULES[_sha]="shamodule.c"
MODULES[_md5]="md5module.c md5.c"
MODULES[_sha256]="sha256module.c"
MODULES[_sha512]="sha512module.c"
MODULES[resource]="resource.c"
MODULES[nis]="nismodule.c"
MODULES[zlib]="zlibmodule.c"
MODULES[binascii]="binascii.c"
MODULES[bz2]="bz2module.c"
MODULES[_elementtree]="_elementtree.c"
MODULES[_multibytecodec]="cjkcodecs/multibytecodec.c"
MODULES[_codecs_kr]="cjkcodecs/_codecs_kr.c"
MODULES[_codecs_jp]="cjkcodecs/_codecs_jp.c"
MODULES[_codecs_cn]="cjkcodecs/_codecs_cn.c"
MODULES[_codecs_tw]="cjkcodecs/_codecs_tw.c"
MODULES[_codecs_hk]="cjkcodecs/_codecs_hk.c"
MODULES[_codecs_iso2022]="cjkcodecs/_codecs_iso2022.c"
MODULES[dl]="dlmodule.c"
MODULES[pyexpat]="pyexpat.c expat/xmlparse.c expat/xmlrole.c expat/xmltok.c"
MODULES[parser]="parsermodule.c"
MODULES[_struct]="_struct.c"

# Disabled because it's useless in our environment and will fail anyway.
# MODULES[termios]="termios.c"

# Requires external libraries which are too much work to compile.
# MODULES[gdbm]="gdbmmodule.c"

# This is disabled due to problems with libffi headers.
# MODULES[_ctypes]="_ctypes/_ctypes.c _ctypes/callbacks.c _ctypes/callproc.c _ctypes/stgdict.c _ctypes/cfield.c"

# These are baked into the main executable but can also be built separately.
# MODULES[_symtable]="symtablemodule.c"
# MODULES[zipimport]="zipimport.c"

# These are disabled because they contain inline assembly.
# MODULES[fpectl]="fpectlmodule.c"
# MODULES[select]="selectmodule.c"
# MODULES[linuxaudiodev]="linuxaudiodev.c"
# MODULES[ossaudiodev]="ossaudiodev.c"

################################################################################
#                                   Patches                                    #
################################################################################

CORRECT_OVERFLOWS_LINES='["stringobject.c:1271","intobject.c:800","longobject.c:1367","dlmalloc.c:4647","peephole.c:624","367189","tupleobject.c:352","10456","binascii.c:1159","typeobject.c:2507","typeobject.c:2474","longobject.c:839","407211","_randommodule.c:154","unicodedata.c:965","peephole.c:556","longobject.c:113","unicodeobject.c:6552","418798","215089","intobject.c:767","10542","intobject.c:522","unicodedata.c:957","dictobject.c:443","469034","215967","longobject.c:2431","_randommodule.c:189","10618","_randommodule.c:181","object.c:1069","418680","dictobject.c:365","mystrtoul.c:220"]'

CORRECT_SIGNS_LINES='["compile.c:3542","dlmalloc.c:4235","longobject.c:889","longobject.c:881","longobject.c:2490","unicodeobject.c:6552","typeobject.c:2474","longobject.c:155","unicodedata.c:965","longobject.c:2400","listobject.c:51","fastsearch.h:65","longobject.c:2395","ceval.c:988","setobject.c:259","peephole.c:581","peephole.c:429","binascii.c:722","_randommodule.c:140","stringobject.c:1271","dlmalloc.c:4205","stringobject.c:1174","compile.c:3792","compile.c:3796","compile.c:3794","_randommodule.c:154","peephole.c:624","stringobject.c:72","binascii.c:510","dlmalloc.c:4816","dlmalloc.c:4227","symtable.c:488","symtable.c:484","binascii.c:876","peephole.c:615","mystrtoul.c:224","compile.c:3461","binascii.c:316","binascii.c:1365","tupleobject.c:352","binascii.c:1044","setobject.c:118","compile.c:3934","peephole.c:602","compile.c:3670","longobject.c:836","dlmalloc.c:4246","dictobject.c:569","symtable.c:702","compile.c:3692","binascii.c:398","unicodedata.c:957","dictobject.c:442","dictobject.c:443","_randommodule.c:108","_randommodule.c:189","peephole.c:460","binascii.c:660","_randommodule.c:181","peephole.c:377","dictobject.c:365","dictobject.c:364","marshal.c:107","dlmalloc.c:4191","compile.c:3728","dlmalloc.c:4199","typeobject.c:2507","_randommodule.c:112","_randommodule.c:115","peephole.c:556","setobject.c:189","binascii.c:653","stringobject.c:108","compile.c:3451","compile.c:3730","marshal.c:114","binascii.c:424","compile.c:3433","binascii.c:833","longobject.c:2484","longobject.c:163","_randommodule.c:124","peephole.c:446","_randommodule.c:121","longobject.c:2431","compile.c:3440","ceval.c:2487"]'

################################################################################
#                                  Functions                                   #
################################################################################

function build_module {
  echo "  Building $1..."

  # Compile.
  FLAGS="-c -emit-llvm -fPIC -fno-strict-aliasing -I. -IInclude -I../cpython/Include -I../cpython/Modules/expat -Wstrict-prototypes"
  FILES=""
  for ((i=2; i<=$#; i++)); do
    ../ccproxy.py $FLAGS ../cpython/Modules/${!i} -o `basename ${!i}`.o
    FILES="$FILES `basename ${!i}`.o"
  done

  # Link.
  ../ccproxy.py $FILES -o $1.so.bc

  # Emscript.
  $PYTHON ../emscripten/emscripten.py $1.so.bc \
      -o $1.so.js \
      -s BUILD_AS_SHARED_LIB=1 \
      -s EXPORTED_FUNCTIONS="[\"_init$1\"]" \
      -s CORRECT_SIGNS=2 -s CORRECT_SIGNS_LINES=$CORRECT_SIGNS_LINES \
      -s CORRECT_OVERFLOWS=2 -s CORRECT_OVERFLOWS_LINES=$CORRECT_OVERFLOWS_LINES \
      $OPTIMIZATION_ARGS

  # Run eliminator.
  ../emscripten/tools/eliminator/node_modules/coffee-script/bin/coffee ../emscripten/tools/eliminator/eliminator.coffee < $1.so.js > $1.so.elim.js 2>/dev/null

  # Copy the new module to dist.
  cp $1.so.elim.js ../dist/lib/python2.7/$1.so.js
}

################################################################################
#                                    Script                                    #
################################################################################

# TODO: Make it possible to build only the main python.js, only modules or only
#       a specific module.

# Exit on first error.
set -e

# Setup optimization flags for all future emscripting.
if [ $OPTIMIZED -eq 1 ]; then
  # TODO: Figure out if reloop is possible and useful.
  OPTIMIZATION_ARGS="-O -s OPTIMIZE=1 -s RELOOP=1 -s ASSERTIONS=0"
else
  OPTIMIZATION_ARGS="   -s OPTIMIZE=0 -s RELOOP=0 -s ASSERTIONS=1"
fi

# Create two folders for intermediate and final files, respectively.
mkdir -p obj
mkdir -p dist

# Remove old build.
rm -rf obj/*
rm -rf dist/{*.js,lib,include}

# Start building in the obj folder.
cd obj

# Create the Makefile and configurations using a filtering proxy for llvm-gcc.
CC=../ccproxy.py ../cpython/configure --without-threads --without-pymalloc

# Adjust configuration.
# Remove the closing endif so we can insert new options.
sed -i 's~#endif /\*Py_PYCONFIG_H\*/~~' pyconfig.h
# Emscripten doesn't support CPU-specific assembly code.
echo '#undef HAVE_GCC_ASM_FOR_X87' >> pyconfig.h
# Emscripten does not support interrupt signals.
echo '#undef HAVE_SIGACTION' >> pyconfig.h
echo '#undef HAVE_SIGINTERRUPT' >> pyconfig.h
echo '#undef HAVE_SIGRELSE' >> pyconfig.h
# Put the closing endif back.
echo '#endif /*Py_PYCONFIG_H*/' >> pyconfig.h

# Compile CPython.
echo 'Compiling...'
make

# Link the resulting libraries. Discard the main function.
echo 'Relinking...'
mkdir -p relinked
cd relinked
ar x ../libpython2.7.a
rm main.o
${LLVM}/llvm-link -o=python.bc *.o
cp python.bc ..
cd ..

# Compile the bytecode into JS using Emscripten.
echo 'Emscripting...'
$PYTHON ../emscripten/emscripten.py python.bc \
    -m \
    -o python.js \
    -s INVOKE_RUN=0 \
    -s INCLUDE_FULL_LIBRARY=1 \
    -s CORRECT_SIGNS=2 -s CORRECT_SIGNS_LINES=$CORRECT_SIGNS_LINES \
    -s CORRECT_OVERFLOWS=2 -s CORRECT_OVERFLOWS_LINES=$CORRECT_OVERFLOWS_LINES \
    $OPTIMIZATION_ARGS

# Copy the main Python JS executable to dist.
cp python.js ../dist/python.js

# Copy the pure Python modules to dist.
mkdir -p ../dist/lib
mkdir -p ../dist/lib/python2.7
cp -r ../cpython/Lib/* ../dist/lib/python2.7
rm -rf ../dist/lib/python2.7/{idlelib,lib-tk,multiprocessing,curses,bsddb}
rm -rf ../dist/lib/python2.7/plat-{aix3,aix4,atheos,beos5,darwin,freebsd4,freebsd5,freebsd6,freebsd7,freebsd8,generic,irix5,irix6,mac,netbsd1,next3,os2emx,riscos,sunos5,unixware7}
if [ $OPTIMIZED -eq 1 ]; then
  rm -rf ../dist/lib/python2.7/test
  rm -rf ../dist/lib/python2.7/*/test{,s}
fi
find ../dist -name '*.pyc' | xargs rm
# Make sure everything is readable and folders are executable (browseable).
chmod -R ugo+rX ../dist

# Copy the configs.
mkdir -p ../dist/lib/python2.7/config
cp Makefile Modules/{Setup*,config.c} ../dist/lib/python2.7/config
cp ../cpython/{Modules/{config.c.in,makesetup},install-sh} ../dist/lib/python2.7/config
mkdir -p ../dist/include
mkdir -p ../dist/include/python2.7
cp pyconfig.h ../dist/include/python2.7/

# Build dynamically loaded modules.
echo 'Building dynamic modules...'
for i in "${!MODULES[@]}"; do
  build_module $i ${MODULES[$i]}
done

# Create virtual file system entries.
echo 'Mapping virtual filesystem.'
python2 ../map_filesystem.py ../dist >> ../dist/python.js

# Add a tiny handcoded JavaScript API.
echo 'Adding entry point.'
cat ../entry_point.js >> ../dist/python.js

# Run optimizations.
if [ $OPTIMIZED -eq 1 ]; then
  echo 'Running eliminator...'
  ../emscripten/tools/eliminator/node_modules/coffee-script/bin/coffee ../emscripten/tools/eliminator/eliminator.coffee < ../dist/python.js > ../dist/python.elim.js 2>/dev/null

  echo 'Minifying...'
  ./minify.py
else
  cp ../dist/python.js ../dist/python.elim.js
  cp ../dist/python.js ../dist/python.opt.js
fi
